openapi: 3.0.0
info:
  title: MentorMe Mobile API Documentation
  version: 1.0.1
  description: API documentation for MentorMe Mobile backend - Nền tảng kết nối Mentor và Mentee
  contact:
    name: Nhóm 12 - Đồ án NT118
    email: 23521389@gm.uit.edu.vn

servers:
  - url: http://localhost:4000/api/v1
    description: Development server

tags:
  - name: Auth
    description: Xác thực người dùng (đăng ký, đăng nhập, đăng xuất)
  - name: Users
    description: Quản trị người dùng (admin/root)
  - name: Profile
    description: Onboarding hồ sơ người dùng (tạo hồ sơ bắt buộc theo role + upload avatar) - Chỉnh sửa, xem hồ sơ sẽ có sau
  - name: Availability
    description: Quản lý slot trống của mentor (tạo draft, publish một lần hoặc lặp RRULE, xem lịch công khai)
  - name: Bookings
    description: Booking flow (create, list, detail, cancel, mentor confirm/decline)
  - name: Notifications
    description: Thiết bị & push notifications
  - name: Mentors
    description: Danh sách và chi tiết mentor (public discovery)
  - name: Wallet
    description: Quản lý ví điện tử của mentee (nạp tiền, trừ tiền, xem lịch sử giao dịch)
  - name: Payments
    description: Webhook thanh toán
  - name: MentorPayout
    description: Payout requests for mentors (mock implementation)
  - name: Reports
    description: Báo cáo (stub)
  - name: Webhooks
    description: Mock webhooks from payout provider
  - name: Home
    description: Home screen statistics (mentor count, session count, ratings, online users)
  - name: Presence
    description: User presence tracking (ping to update online status)
  - name: Reviews
    description: Review and rating system (mentee reviews mentor after completed booking)
  - name: Sessions
    description: WebRTC signaling guard (join token + waiting room) and session logs
  - name: Messages
    description: Chat between mentor and mentee (booking-based)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  examples:
    calendar_success_min:
      summary: Calendar trong khoảng from/to (tối giản)
      value:
        success: true
        message: OK
        data:
          items:
            - id: "66aa1b2c0000000000000001"
              start: "2025-11-03T01:00:00Z"
              end: "2025-11-03T01:30:00Z"
              status: "open"
              slot: { id: "00000000000000000000A001", title: null, description: null }

    calendar_400_min:
      summary: Calendar 400 khi from/to sai
      value:
        success: false
        message: "Invalid or missing from/to (ISO UTC expected)"
        data: null

    delete_slot_409:
      summary: Xoá bị chặn do có booking tương lai
      value:
        message: "slot has booked occurrences"
        code: "CONFLICT_BOOKED"
        data: null

  schemas:
    ApiEnvelope:
      type: object
      properties:
        success: { type: boolean, example: true }
        message: { type: string, example: OK }
        data:
          nullable: true
          description: Payload specific to the endpoint

    MentorCard:
      type: object
      properties:
        id:        { type: string, example: "68e0f6de7f19db9cfeb0df48" }
        ownerId:   { type: string, example: "68e0f6de7f19db9cfeb0df48" }
        userId:    { type: string, example: "68e0f6de7f19db9cfeb0df48" }
        name:      { type: string, example: "Nguyễn Văn A" }
        role:      { type: string, example: "Mobile Engineer" }
        company:   { type: string, example: "UIT" }
        rating:    { type: number, format: float, example: 4.7 }
        ratingCount: { type: integer, example: 123 }
        hourlyRate:
          type: integer
          example: 250000
        skills:
          type: array
          items: { type: string }
          example: ["Kotlin","Compose","Android"]
        avatarUrl: { type: string, format: uri, example: "https://i.pravatar.cc/256?img=12" }

    MentorListPayload:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/MentorCard" }
        page:  { type: integer, example: 1 }
        limit: { type: integer, example: 20 }
        total: { type: integer, example: 123 }

    UpdateSlotRequest:
      type: object
      properties:
        title:        { type: string, example: "[type=in-person] Tư vấn trực tiếp" }
        description:  { type: string, example: "Fix CV + mock interview" }
        timezone:     { type: string, example: "Asia/Ho_Chi_Minh" }
        start:        { type: string, format: date-time, example: "2025-11-03T07:30:00Z" }
        end:          { type: string, format: date-time, example: "2025-11-03T08:00:00Z" }
        priceVnd:     { type: number, minimum: 0, example: 250000 }
        visibility:   { type: string, enum: [public, private] }
        action:       { type: string, enum: [pause, resume], description: "pause=đóng occurrences tương lai; resume=mở lại" }

    BookingStatus:
      type: string
      enum:
        [
          PaymentPending,
          PendingMentor,
          Confirmed,
          Failed,
          Cancelled,
          Declined,
          Completed,
          NoShowMentor,
          NoShowMentee,
          NoShowBoth,
        ]

    Booking:
      type: object
      properties:
        id: { type: string, example: "66aa1b2c0000000000000001" }
        menteeId: { type: string, example: "66aa1b2c0000000000000002" }
        mentorId: { type: string, example: "66aa1b2c0000000000000003" }
        occurrenceId: { type: string, example: "66aa1b2c0000000000000004" }
        date: { type: string, example: "2025-11-03" }
        startTime: { type: string, example: "07:30" }
        endTime: { type: string, example: "08:00" }
        startTimeIso: { type: string, format: date-time }
        endTimeIso: { type: string, format: date-time }
        status: { $ref: "#/components/schemas/BookingStatus" }
        price: { type: number, example: 250000 }
        topic: { type: string, nullable: true }
        notes: { type: string, nullable: true }
        meetingLink: { type: string, nullable: true }
        location: { type: string, nullable: true }
        expiresAt: { type: string, format: date-time, nullable: true }
        mentorResponseDeadline: { type: string, format: date-time, nullable: true }
        reminder24hSentAt: { type: string, format: date-time, nullable: true }
        reminder1hSentAt: { type: string, format: date-time, nullable: true }
        lateCancel: { type: boolean, example: false }
        lateCancelMinutes: { type: integer, nullable: true }
        createdAt: { type: string, format: date-time }

    BookingListPayload:
      type: object
      properties:
        bookings:
          type: array
          items: { $ref: "#/components/schemas/Booking" }
        total: { type: integer, example: 1 }
        page: { type: integer, example: 1 }
        totalPages: { type: integer, example: 1 }

    CreateBookingRequest:
      type: object
      required: [mentorId, occurrenceId]
      properties:
        mentorId: { type: string }
        occurrenceId: { type: string }
        topic: { type: string }
        notes: { type: string }

    CancelBookingRequest:
      type: object
      properties:
        reason: { type: string }

    MentorDeclineRequest:
      type: object
      properties:
        reason: { type: string }

    DeviceTokenRegisterRequest:
      type: object
      required: [token]
      properties:
        token: { type: string }
        platform: { type: string, enum: [android, ios, web] }
        deviceId: { type: string }

    DeviceTokenUnregisterRequest:
      type: object
      properties:
        token: { type: string }

    PushTestRequest:
      type: object
      properties:
        title: { type: string }
        body: { type: string }
        data:
          type: object
          additionalProperties: { type: string }

    PushToUserRequest:
      type: object
      required: [userId, title, body]
      properties:
        userId: { type: string }
        title: { type: string }
        body: { type: string }
        data:
          type: object
          additionalProperties: { type: string }

    PushResult:
      type: object
      properties:
        sent: { type: integer, example: 1 }
        failed: { type: integer, example: 0 }
        invalid: { type: integer, example: 0 }
        skipped: { type: integer, example: 0 }


    ApiResponse:
      type: object
      properties:
        message:
          type: string
          example: Sign-in successful
        data:
          nullable: true
          description: Payload specific to the endpoint
      required: [message]

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: Bad Request
        code:
          type: string
          description: Short machine-readable error key
          example: INVALID_INPUT
        errors:
          type: object
          additionalProperties: true
          description: Field-level validation details
        data:
          nullable: true
          example: null
      required: [message]

    SignUpMenteeRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          example: mentee1@example.com
        userName:
          type: string
          example: Alex
        password:
          type: string
          format: password
          example: strongPassword123
      required: [email, userName, password]

    SignUpMenteeResponseData:
      type: object
      properties:
        userId:
          type: string
          example: "665f1a9b3bcf9a4d0a2f1bcd"
        email:
          type: string
          format: email
        userName:
          type: string
        status:
          type: string
          enum: [pending, active]
          example: pending
        verificationId:
          type: string
          description: Identifier to use when verifying OTP
          example: "9f8a1ac51e4f4a609b2d2a3f4b3e7c12"
        expiresIn:
          type: integer
          description: OTP time to live in seconds
          example: 600
      required: [userId, email, userName, status, verificationId, expiresIn]

    SignUpMentorRequest:
      allOf:
        - $ref: "#/components/schemas/SignUpMenteeRequest"
      description: Same fields as mentee signup

    SignUpMentorResponseData:
      type: object
      properties:
        userId:
          type: string
        email:
          type: string
          format: email
        userName:
          type: string
        status:
          type: string
          enum: [pending-mentor]
          example: pending-mentor
        role:
          type: string
          enum: [mentor]
          example: mentor
      required: [userId, email, userName, status, role]

    SignInRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          example: mentee1@example.com
        password:
          type: string
          format: password
          example: strongPassword123
      required: [email, password]

    SignInResponseData:
      type: object
      properties:
        email:
          type: string
          format: email
        role:
          type: string
          enum: [mentee, mentor, admin]
          example: mentee
        userId:
          type: string
        status:
          type: string
          enum: [active, pending, pending-mentor]
          example: active
        token:
          type: string
          description: JWT token (7d expiry)
      required: [email, role, userId, status]

    VerifyOtpRequest:
      type: object
      properties:
        verificationId:
          type: string
          example: "9f8a1ac51e4f4a609b2d2a3f4b3e7c12"
        code:
          type: string
          pattern: '^\\d{6}$'
          example: "123456"
      required: [verificationId, code]

    VerifyOtpResponseData:
      type: object
      properties:
        email:
          type: string
          format: email
        userId:
          type: string
        status:
          type: string
          enum: [active, pending-mentor]
        token:
          type: string
          nullable: true
          description: Present only when status becomes active (mentee flow)
      required: [email, userId, status]

    ProfileLinks:
      type: object
      properties:
        website: { type: string, format: uri }
        twitter: { type: string, format: uri }
        linkedin: { type: string, format: uri }
        github: { type: string, format: uri }
        youtube: { type: string, format: uri }
        facebook: { type: string, format: uri }

    Profile:
      type: object
      properties:
        _id: { type: string, example: "66e0c2...abc" }
        user: { type: string, example: "66e0c2...def" }
        # common
        location: { type: string, example: "Hồ Chí Minh" }
        category: { type: string, example: "Backend" }
        languages:
          type: array
          items: { type: string }
          example: ["vi", "en"]
        avatarUrl: { type: string, format: uri }
        avatarPublicId: { type: string }
        links:
          $ref: "#/components/schemas/ProfileLinks"
        profileCompleted: { type: boolean, example: true }
        # mentor
        jobTitle: { type: string, example: "Senior Software Engineer" }
        experience: { type: string, example: "5+ years" }
        headline: { type: string, example: "Mentor Node.js/MongoDB" }
        mentorReason: { type: string }
        greatestAchievement: { type: string }
        introVideo: { type: string, format: uri, nullable: true }
        bio: { type: string }
        # mentee
        description: { type: string }
        goal: { type: string }
        education: { type: string }
        # shared business
        skills:
          type: array
          items: { type: string }
          example: ["Node.js", "MongoDB"]
        rating:
          type: object
          properties:
            average: { type: number, format: float }
            count: { type: integer }
      required:
        [user, location, category, languages, avatarUrl, profileCompleted]

    CreateProfileCommonJSON:
      type: object
      properties:
        location: { type: string }
        category: { type: string }
        languages:
          oneOf:
            - type: array
              items: { type: string }
            - type: string
          description: "Mảng hoặc chuỗi CSV: 'vi,en'"
        avatarUrl:
          type: string
          format: uri
          description: "Link ảnh; server sẽ tải lên Cloudinary"
        links:
          $ref: "#/components/schemas/ProfileLinks"
      required: [location, category, languages, avatarUrl]

    CreateProfileMentorJSON:
      allOf:
        - $ref: "#/components/schemas/CreateProfileCommonJSON"
        - type: object
          properties:
            jobTitle: { type: string }
            experience: { type: string }
            headline: { type: string }
            mentorReason: { type: string }
            greatestAchievement: { type: string }
            skills:
              oneOf:
                - type: array
                  items: { type: string }
                - type: string
              description: "Mảng hoặc chuỗi CSV"
            bio: { type: string }
            introVideo: { type: string, format: uri, nullable: true }
          required:
            [
              jobTitle,
              experience,
              headline,
              mentorReason,
              greatestAchievement,
              skills,
            ]

    CreateProfileMenteeJSON:
      allOf:
        - $ref: "#/components/schemas/CreateProfileCommonJSON"
        - type: object
          properties:
            description: { type: string }
            goal: { type: string }
            education: { type: string }
            skills:
              oneOf:
                - type: array
                  items: { type: string }
                - type: string
              description: "Mảng hoặc chuỗi CSV"
          required: [description, goal, education, skills]

    CreateProfileCommonMultipart:
      type: object
      properties:
        avatar:
          type: string
          format: binary
          description: "File ảnh avatar (thay vì avatarUrl); có thể gửi cùng các field text"
        avatarUrl:
          type: string
          format: uri
          description: "Tuỳ chọn: nếu không upload file, có thể gửi URL"
        location: { type: string }
        category: { type: string }
        languages:
          type: string
          description: "Chuỗi CSV: 'vi,en' hoặc lặp key nhiều lần"
        links:
          $ref: "#/components/schemas/ProfileLinks"
      required: [location, category, languages] # cần avatar hoặc avatarUrl (ít nhất một)

    CreateProfileMentorMultipart:
      allOf:
        - $ref: "#/components/schemas/CreateProfileCommonMultipart"
        - type: object
          properties:
            jobTitle: { type: string }
            experience: { type: string }
            headline: { type: string }
            mentorReason: { type: string }
            greatestAchievement: { type: string }
            skills: { type: string, description: "CSV hoặc lặp key" }
            bio: { type: string }
            introVideo: { type: string, format: uri, nullable: true }
          required:
            [
              jobTitle,
              experience,
              headline,
              mentorReason,
              greatestAchievement,
              skills,
            ]

    CreateProfileMenteeMultipart:
      allOf:
        - $ref: "#/components/schemas/CreateProfileCommonMultipart"
        - type: object
          properties:
            description: { type: string }
            goal: { type: string }
            education: { type: string }
            skills: { type: string, description: "CSV hoặc lặp key" }
          required: [description, goal, education, skills]

    ValidationErrorWithMissing:
      type: object
      properties:
        message:
          type: string
          example: "Missing required fields for mentee: description, goal, education, skills"
        data:
          type: object
          properties:
            missing:
              type: array
              items: { type: string }
              example: ["description", "goal", "education", "skills"]
      required: [message]

    # ===== AVAILABILITY SCHEMAS =====
    AvailabilitySlot:
      type: object
      properties:
        _id: { type: string, example: "68e0fef4d73c9fd4063f958a" }
        mentor: { type: string, example: "68e0f6de7f19db9cfeb0df48" }
        title: { type: string, nullable: true }
        description: { type: string, nullable: true }
        timezone: { type: string, example: "Asia/Ho_Chi_Minh" }
        start: { type: string, format: date-time, nullable: true, description: "UTC ISO start (one-off hoặc anchor cho RRULE)" }
        end: { type: string, format: date-time, nullable: true, description: "UTC ISO end" }
        rrule: { type: string, nullable: true, example: "FREQ=WEEKLY;BYDAY=MO,TH;COUNT=8" }
        exdates:
          type: array
          items: { type: string, format: date-time }
          description: "Danh sách ngày giờ (UTC) loại trừ – phải trùng với các lần phát sinh của RRULE"
          bufferBeforeMin: { type: integer, example: 5 }
          bufferAfterMin: { type: integer, example: 10 }
          priceVnd: { type: number, example: 250000 }
          visibility: { type: string, enum: [public, private], example: public }
        status: { type: string, enum: [draft, published, archived], example: draft }
        publishHorizonDays: { type: integer, example: 45 }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    AvailabilityOccurrence:
      type: object
      properties:
        _id: { type: string }
        slot: { type: string }
        mentor: { type: string }
        start: { type: string, format: date-time }
        end: { type: string, format: date-time }
        visibility: { type: string, enum: [public, private], example: public }
        status: { type: string, enum: [open, booked, closed], example: open }
        capacity: { type: integer, example: 1 }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CreateSlotRequest:
      type: object
      properties:
        timezone: { type: string, example: "Asia/Ho_Chi_Minh" }
        title: { type: string }
        description: { type: string }
        start: { type: string, format: date-time, description: "Bắt buộc (one-off hoặc anchor cho RRULE)" }
        end: { type: string, format: date-time, description: "Bắt buộc; phải sau start" }
        rrule: { type: string, nullable: true, description: "Chuỗi RRULE (DAILY/WEEKLY subset) hoặc bỏ trống" }
        exdates:
          type: array
          items: { type: string, format: date-time }
          bufferBeforeMin: { type: integer, minimum: 0, example: 0 }
          bufferAfterMin: { type: integer, minimum: 0, example: 0 }
          priceVnd: { type: number, minimum: 0, example: 250000 }
          visibility: { type: string, enum: [public, private], example: public }
        publishHorizonDays: { type: integer, minimum: 1, maximum: 365, example: 90 }
      required: [timezone, start, end]

    CreateSlotResponse:
      type: object
      properties:
        message: { type: string, example: "Created" }
        slot:
          $ref: "#/components/schemas/AvailabilitySlot"
      required: [slot]

    PublishSlotResponse:
      type: object
      properties:
        published: { type: boolean, example: true }
        occurrencesCreated: { type: integer, example: 5 }
        skippedConflict: { type: integer, example: 1 }
        rrule: { type: string, nullable: true }
        horizonDays: { type: integer, example: 45 }

    CalendarItem:
      type: object
      properties:
        id:         { type: string, example: "66aa1b2c0000000000000001" }
        start:      { type: string, format: date-time, example: "2025-11-03T01:00:00Z" }
        end:        { type: string, format: date-time, example: "2025-11-03T01:30:00Z" }
        status:     { type: string, enum: [open, booked, closed], example: open }
        title:        { type: string, nullable: true, example: "[type=in-person] Tư vấn trực tiếp" }
        description:  { type: string, nullable: true, example: "Fix CV" }
        priceVnd:     { type: number, nullable: true, example: 250000 }
        slot:
            type: object
            properties:
              id:          { type: string, example: "00000000000000000000A001" }
              title:       { type: string, nullable: true, example: "[type=in-person] Tư vấn trực tiếp" }
              description: { type: string, nullable: true, example: "Fix CV" }
              priceVnd:    { type: number, nullable: true, example: 250000 }

    CalendarPayload:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/CalendarItem" }

    AvailabilityValidationErrorExample:
      type: object
      properties:
        message: { type: string, example: "Invalid RRULE format" }
        data: { type: null, nullable: true }

    AdminLoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string, example: "admin@example.com" }
        password: { type: string, example: "Admin123!" }

    AdminLoginResponseData:
      type: object
      properties:
        accessToken: { type: string }
        role: { type: string, enum: [admin, root] }
        userId: { type: string }
        email: { type: string, format: email }
      required: [accessToken, role, userId, email]

    CurrentUserResponseData:
      type: object
      properties:
        userId: { type: string }
        email: { type: string, format: email }
        userName: { type: string }
        role: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        profile:
          type: object
          properties:
            profileCompleted: { type: boolean }
            avatarUrl: { type: string }
            avatarPublicId: { type: string, nullable: true }
        profileCompleted: { type: boolean }
        next: { type: string, example: "/home" }

    ProfilePublic:
      type: object
      properties:
        fullName: { type: string }
        avatarUrl: { type: string, format: uri }
        bio: { type: string }
        headline: { type: string }
        location: { type: string }
        jobTitle: { type: string }
        experience: { type: string }
        education: { type: string }
        skills:
          type: array
          items: { type: string }
        languages:
          type: array
          items: { type: string }
        links:
          $ref: "#/components/schemas/ProfileLinks"

    ProfileUpdateRequest:
      type: object
      properties:
        fullName: { type: string }
        phone: { type: string }
        location: { type: string }
        bio: { type: string }
        languages:
          oneOf:
            - type: array
              items: { type: string }
            - type: string
          description: "Mảng hoặc chuỗi CSV: 'vi,en'"
        skills:
          oneOf:
            - type: array
              items: { type: string }
            - type: string
          description: "Mảng hoặc chuỗi CSV: 'Node.js, MongoDB'"
        jobTitle: { type: string }
        experience: { type: string }
        headline: { type: string }
        description: { type: string }
        goal: { type: string }
        education: { type: string }
        website: { type: string, format: uri }
        twitter: { type: string, format: uri }
        linkedin: { type: string, format: uri }
        github: { type: string, format: uri }
        youtube: { type: string, format: uri }
        facebook: { type: string, format: uri }

    ProfileUpdateMultipart:
      type: object
      properties:
        avatar: { type: string, format: binary }
        fullName: { type: string }
        phone: { type: string }
        location: { type: string }
        bio: { type: string }
        languages: { type: string, description: "Chuỗi CSV: 'vi,en'" }
        skills: { type: string, description: "Chuỗi CSV: 'Node.js, MongoDB'" }
        jobTitle: { type: string }
        experience: { type: string }
        headline: { type: string }
        description: { type: string }
        goal: { type: string }
        education: { type: string }
        website: { type: string, format: uri }
        twitter: { type: string, format: uri }
        linkedin: { type: string, format: uri }
        github: { type: string, format: uri }
        youtube: { type: string, format: uri }
        facebook: { type: string, format: uri }

    ProfileListItem:
      allOf:
        - $ref: "#/components/schemas/Profile"
        - type: object
          properties:
            id: { type: string }
            userId: { type: string }

    UserAdmin:
      type: object
      properties:
        id: { type: string }
        email: { type: string, format: email }
        userName: { type: string }
        name: { type: string }
        role: { type: string, enum: [mentee, mentor, admin, root] }
        status: { type: string, enum: [active, verifying, pending-mentor, onboarding] }
        isBlocked: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    AdminCreateUserRequest:
      type: object
      required: [email, userName]
      properties:
        email: { type: string, format: email }
        userName: { type: string }
        name: { type: string }
        role: { type: string, enum: [mentee, mentor, admin, root] }
        password: { type: string }
        status: { type: string, enum: [active, verifying, pending-mentor, onboarding] }

    AdminUpdateUserRequest:
      type: object
      properties:
        email: { type: string, format: email }
        userName: { type: string }
        name: { type: string }
        role: { type: string, enum: [mentee, mentor, admin, root] }
        status: { type: string, enum: [active, verifying, pending-mentor, onboarding] }
        isBlocked: { type: boolean }

    AdminChangePasswordRequest:
      type: object
      required: [password]
      properties:
        password: { type: string, minLength: 6 }

    ChangeMyPasswordRequest:
      type: object
      required: [currentPassword, newPassword]
      properties:
        currentPassword: { type: string }
        newPassword: { type: string, minLength: 6 }

    RejectMentorRequest:
      type: object
      properties:
        reason: { type: string }

    PaymentWebhookRequest:
      type: object
      required: [event, bookingId]
      properties:
        event: { type: string, example: "payment.success" }
        bookingId: { type: string }
        paymentId: { type: string }
        status: { type: string }
        metadata:
          type: object
          additionalProperties: true

    PaymentWebhookResponseData:
      type: object
      properties:
        processed: { type: boolean, example: true }
        event: { type: string }
        bookingId: { type: string }

    DeviceTokenListItem:
      type: object
      properties:
        id: { type: string }
        userId: { type: string }
        token: { type: string, nullable: true }
        tokenMasked: { type: string }
        platform: { type: string, nullable: true }
        deviceId: { type: string, nullable: true }
        lastSeenAt: { type: string, format: date-time, nullable: true }
        createdAt: { type: string, format: date-time, nullable: true }
        updatedAt: { type: string, format: date-time, nullable: true }
        user:
          type: object
          nullable: true
          properties:
            id: { type: string }
            email: { type: string, format: email, nullable: true }
            userName: { type: string, nullable: true }
            role: { type: string, nullable: true }
            status: { type: string, nullable: true }

    DeviceTokenListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/DeviceTokenListItem" }
        total: { type: integer, example: 1 }
        page: { type: integer, example: 1 }
        limit: { type: integer, example: 50 }

    NotificationType:
      type: string
      enum:
        - booking_confirmed
        - booking_failed
        - booking_cancelled
        - booking_reminder
        - booking_pending
        - booking_declined
        - booking_no_show
        - payment_success
        - payment_failed

    NotificationItem:
      type: object
      properties:
        id: { type: string }
        type: { $ref: "#/components/schemas/NotificationType" }
        title: { type: string }
        body: { type: string }
        data:
          type: object
          nullable: true
          additionalProperties: true
        read: { type: boolean }
        createdAt: { type: string, format: date-time, nullable: true }

    NotificationListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/NotificationItem" }
        total: { type: integer, example: 1 }
        page: { type: integer, example: 1 }
        limit: { type: integer, example: 20 }

    NotificationUnreadCountResponse:
      type: object
      properties:
        unread: { type: integer, example: 3 }

    NotificationReadResponse:
      type: object
      properties:
        id: { type: string }
        read: { type: boolean, example: true }

    NotificationReadAllResponse:
      type: object
      properties:
        updated: { type: integer, example: 10 }

    NotificationPreferences:
      type: object
      properties:
        pushBooking: { type: boolean, example: true }
        pushPayment: { type: boolean, example: true }
        pushMessage: { type: boolean, example: true }
        pushSystem: { type: boolean, example: true }

    Report:
      type: object
      properties:
        id: { type: string }
        status: { type: string, example: "pending" }

paths:
  /auth/signup:
    post:
      tags: [Auth]
      summary: Sign up as mentee (sends OTP)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignUpMenteeRequest"
      responses:
        "201":
          description: User created (pending) and OTP sent
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/SignUpMenteeResponseData"
        "400":
          description: Missing/invalid inputs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error (create user / send OTP failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/signup-mentor:
    post:
      tags: [Auth]
      summary: Sign up as mentor (application review flow)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignUpMentorRequest"
      responses:
        "201":
          description: Mentor application received
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/SignUpMentorResponseData"
        "400":
          description: Missing/invalid inputs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error (create user failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/signin:
    post:
      tags: [Auth]
      summary: Sign in with email & password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignInRequest"
      responses:
        "200":
          description: Sign-in successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/SignInResponseData"
        "400":
          description: Missing/invalid inputs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missing_fields:
                  value:
                    { message: "email and password are required", code: "MISSING_FIELDS", errors: { email: "required", password: "required" }, data: null }
        "401":
          description: Invalid email or password / inactive user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid_credentials:
                  value: { message: "Invalid email or password", code: "INVALID_CREDENTIALS", data: null }
                inactive_user:
                  value: { message: "Account is not active", code: "USER_INACTIVE", data: null }

  /auth/verify-otp:
    post:
      tags: [Auth]
      summary: Verify email using OTP
      description: |
        Confirms the OTP that was sent via `/auth/signup`. Code paths:
        - **200 (Email verified)**:
          - Mentee: status becomes `active` and a JWT token is returned.
          - Mentor: status becomes `pending-mentor` (no token).
          - Already verified (active): returns status `active` (no token).
        - **400**: missing fields, invalid format, expired/missing OTP, invalid OTP, or too many attempts.
        - **404**: user not found.
        - **500**: failed to activate account.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyOtpRequest"
      responses:
        "200":
          description: Email verified / already verified
          content:
            application/json:
              examples:
                mentee_activated_with_token:
                  value:
                    message: Email verified
                    data:
                      email: mentee1@example.com
                      userId: "665f1a9b3bcf9a4d0a2f1bcd"
                      status: active
                      token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                already_verified_no_token:
                  value:
                    message: Email already verified
                    data:
                      email: mentee1@example.com
                      userId: "665f1a9b3bcf9a4d0a2f1bcd"
                      status: active
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/VerifyOtpResponseData"
        "400":
          description: Invalid/expired OTP, invalid format, missing fields, or too many attempts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missing_fields: { value: { message: "verificationId and code are required", code: "MISSING_FIELDS", data: null } }
                invalid_format:  { value: { message: "Invalid OTP format (must be 6 digits)", code: "INVALID_FORMAT", data: null } }
                otp_not_found:  { value: { message: "OTP expired or not found", code: "OTP_NOT_FOUND", data: null } }
                invalid_otp:    { value: { message: "Invalid OTP", code: "INVALID_OTP", data: null } }
                too_many_attempts: { value: { message: "Too many attempts. Request a new OTP.", code: "RATE_LIMITED", data: null } }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                user_not_found: { value: { message: "User not found", code: "USER_NOT_FOUND", data: null } }
        "500":
          description: Failed to activate account
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                activate_failed: { value: { message: "Failed to activate account", code: "INTERNAL_ERROR", data: null } }

  /auth/signout:
    post:
      tags: [Auth]
      summary: Sign out and blacklist current token until expiry
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Sign-out successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
        "401":
          description: Missing/invalid token (implementation may still return OK if token absent).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/admin/login:
    post:
      tags: [Auth]
      summary: Admin login
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminLoginRequest" }
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/AdminLoginResponseData"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Account blocked
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /auth/me:
    get:
      tags: [Auth]
      summary: Lấy thông tin user hiện tại
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/CurrentUserResponseData"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  # ===== USERS ENDPOINTS =====
  /users:
    get:
      tags: [Users]
      summary: Danh sách người dùng (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: filter
          schema: { type: string, example: '{"q":"alex","role":"mentor"}' }
          description: JSON filter (q, role, status, isBlocked)
        - in: query
          name: range
          schema: { type: string, example: "[0,9]" }
          description: JSON range [start,end]
        - in: query
          name: sort
          schema: { type: string, example: '["createdAt","DESC"]' }
          description: JSON sort [field, order]
      responses:
        "200":
          description: User list
          headers:
            Content-Range:
              schema: { type: string }
              description: "users start-end/total"
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/UserAdmin" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    post:
      tags: [Users]
      summary: Tạo user (admin/root)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminCreateUserRequest" }
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserAdmin" }
        "400":
          description: Missing/invalid inputs
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Email already exists
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /users/me:
    get:
      tags: [Users]
      summary: Lấy thông tin user hiện tại (alias /auth/me)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/CurrentUserResponseData"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /users/change-password:
    put:
      tags: [Users]
      summary: Đổi mật khẩu của chính mình (admin/root)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ChangeMyPasswordRequest" }
      responses:
        "200":
          description: Password changed
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiResponse" }
        "400":
          description: Missing/invalid inputs
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /users/pending-mentors/count:
    get:
      tags: [Users]
      summary: Đếm mentor đang chờ duyệt (admin/root)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Pending mentors count
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          count: { type: integer, example: 3 }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /users/{id}:
    get:
      tags: [Users]
      summary: Lấy user theo id (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: User detail
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserAdmin" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    put:
      tags: [Users]
      summary: Cập nhật user (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminUpdateUserRequest" }
      responses:
        "200":
          description: User updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserAdmin" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    delete:
      tags: [Users]
      summary: Xoá user (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: User deleted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserAdmin" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /users/{id}/password:
    put:
      tags: [Users]
      summary: Đổi mật khẩu user (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminChangePasswordRequest" }
      responses:
        "200":
          description: Password changed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id: { type: string }
        "400":
          description: Invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /users/{id}/approve:
    put:
      tags: [Users]
      summary: Duyệt mentor (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Mentor approved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id: { type: string }
        "400":
          description: Invalid mentor state
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /users/{id}/reject:
    put:
      tags: [Users]
      summary: Từ chối mentor (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RejectMentorRequest" }
      responses:
        "200":
          description: Mentor rejected
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id: { type: string }
        "400":
          description: Invalid mentor state
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  # ====== PROFILE ENDPOINT ======
  /profile/required:
    post:
      tags: [Profile]
      summary: Tạo hồ sơ bắt buộc (onboarding) theo role của user trong JWT
      description: |
        - **Yêu cầu Bearer JWT**. Role được lấy từ token (`mentee`/`mentor`).
        - **Bắt buộc chung**: `location`, `category`, `languages`, và **avatar** (gửi **file** `avatar` *hoặc* **URL** `avatarUrl`).
        - **Mentor bắt buộc**: `jobTitle`, `experience`, `headline`, `mentorReason`, `greatestAchievement`, `skills`.
        - **Mentee bắt buộc**: `description`, `goal`, `education`, `skills`.
        - `skills`/`languages` có thể gửi **mảng** hoặc **chuỗi CSV** (ví dụ: `"Node.js, MongoDB"` / `"vi,en"`).
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/CreateProfileMentorJSON"
                - $ref: "#/components/schemas/CreateProfileMenteeJSON"
            examples:
              mentor_json:
                summary: Mentor (JSON + avatarUrl)
                value:
                  location: "Hồ Chí Minh"
                  category: "Backend"
                  languages: "vi,en"
                  avatarUrl: "https://picsum.photos/512"
                  jobTitle: "Senior Backend Engineer"
                  experience: "5+ years"
                  headline: "Mentor Node.js/MongoDB"
                  mentorReason: "Muốn chia sẻ kinh nghiệm"
                  greatestAchievement: "Scale API cho 1M users"
                  skills: "Node.js, MongoDB"
                  bio: "Từng dẫn dắt team..."
              mentee_json:
                summary: Mentee (JSON + avatarUrl)
                value:
                  location: "Hồ Chí Minh"
                  category: "Backend"
                  languages: ["vi", "en"]
                  avatarUrl: "https://picsum.photos/512"
                  description: "Sinh viên năm 3 CNTT"
                  goal: "Pass phỏng vấn Backend"
                  education: "UIT"
                  skills: ["Node.js", "MongoDB"]
          multipart/form-data:
            schema:
              oneOf:
                - $ref: "#/components/schemas/CreateProfileMentorMultipart"
                - $ref: "#/components/schemas/CreateProfileMenteeMultipart"
            examples:
              mentor_multipart:
                summary: Mentor (multipart + file avatar)
                value:
                  avatar: (file)
                  location: "Hồ Chí Minh"
                  category: "Backend"
                  languages: "vi,en"
                  jobTitle: "Senior Backend Engineer"
                  experience: "5+ years"
                  headline: "Mentor Node.js/MongoDB"
                  mentorReason: "Muốn chia sẻ kinh nghiệm"
                  greatestAchievement: "Scale API cho 1M users"
                  skills: "Node.js, MongoDB"
              mentee_multipart:
                summary: Mentee (multipart + file avatar)
                value:
                  avatar: (file)
                  location: "Hồ Chí Minh"
                  category: "Backend"
                  languages: "vi,en"
                  description: "Sinh viên năm 3 CNTT"
                  goal: "Pass phỏng vấn Backend"
                  education: "UIT"
                  skills: "Node.js, MongoDB"
      responses:
        "201":
          description: Tạo hồ sơ thành công
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/Profile"
        "400":
          description: Thiếu/không hợp lệ (bao gồm thiếu avatar, thiếu field theo role, introVideo URL không hợp lệ)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ValidationErrorWithMissing"
                  - $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Chưa đăng nhập / token không hợp lệ
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Hồ sơ đã tồn tại
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /profile/me:
    get:
      tags: [Profile]
      summary: Lấy hồ sơ của tôi
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Profile fetched
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          profile: { $ref: "#/components/schemas/Profile" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Profile not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    put:
      tags: [Profile]
      summary: Cập nhật hồ sơ của tôi
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ProfileUpdateRequest" }
          multipart/form-data:
            schema: { $ref: "#/components/schemas/ProfileUpdateMultipart" }
      responses:
        "200":
          description: Profile updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          profile: { $ref: "#/components/schemas/Profile" }
        "400":
          description: Invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Profile not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Upload avatar failed
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /profile/{id}:
    get:
      tags: [Profile]
      summary: Lấy hồ sơ public theo userId
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
          description: userId (không phải profileId)
      responses:
        "200":
          description: Public profile fetched
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          profile: { $ref: "#/components/schemas/ProfilePublic" }
        "404":
          description: Profile not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    delete:
      tags: [Profile]
      summary: Xoá hồ sơ (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
          description: profileId
      responses:
        "200":
          description: Profile deleted
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id: { type: string }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Profile not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /profile:
    get:
      tags: [Profile]
      summary: Danh sách hồ sơ (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: filter
          schema: { type: string, example: '{"q":"node","profileCompleted":"true"}' }
          description: JSON filter (q, category, profileCompleted)
        - in: query
          name: range
          schema: { type: string, example: "[0,9]" }
          description: JSON range [start,end]
        - in: query
          name: sort
          schema: { type: string, example: '["createdAt","DESC"]' }
          description: JSON sort [field, order]
      responses:
        "200":
          description: Profile list
          headers:
            Content-Range:
              schema: { type: string }
              description: "profiles start-end/total"
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ProfileListItem" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  # ===== AVAILABILITY ENDPOINTS =====
  /availability/slots:
    post:
      tags: [Availability]
      summary: Tạo slot (draft)
      description: |
        Mentor tạo slot dạng one-off hoặc recurring (RRULE). Sau khi tạo cần gọi publish để sinh occurrences.
        - Yêu cầu Bearer token với role mentor.
        - Hỗ trợ RRULE subset: FREQ=DAILY|WEEKLY; COUNT; INTERVAL; BYDAY (WEEKLY).
        - `start` / `end` luôn bắt buộc (anchor cho recurring).
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateSlotRequest" }
            examples:
              one_off:
                summary: One-off 30 phút
                value:
                  timezone: Asia/Ho_Chi_Minh
                  title: "One-off mentoring"
                  start: "2025-11-03T07:00:00Z"
                  end: "2025-11-03T07:30:00Z"
                  bufferBeforeMin: 5
                  bufferAfterMin: 10
                  visibility: public
                  publishHorizonDays: 30
              weekly_rrule:
                summary: Weekly Mon/Thu (COUNT=8)
                value:
                  timezone: Asia/Ho_Chi_Minh
                  title: "Weekly mentoring"
                  start: "2025-11-03T07:00:00Z"
                  end: "2025-11-03T07:20:00Z"
                  rrule: "FREQ=WEEKLY;BYDAY=MO,TH;COUNT=8"
                  exdates: []
                  publishHorizonDays: 45
      responses:
        "201":
          description: Slot tạo thành công (draft)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateSlotResponse"
        "400":
          description: Dữ liệu không hợp lệ
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid_rrule:
                  value:
                    message: "Invalid RRULE format"
                    code: INVALID_RRULE
                    data: null
                start_after_end:
                  value:
                    message: "start must be before end"
                    code: START_AFTER_END
                    data: null

        "401":
          description: Chưa đăng nhập hoặc token không hợp lệ
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                unauthorized:
                  value:
                    message: "Unauthorized"
                    code: UNAUTHORIZED
                    data: null

        "403":
          description: Không có quyền (role không phải mentor)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                role_forbidden:
                  value:
                    message: "Only mentors can create availability"
                    code: FORBIDDEN
                    data: null


  /availability/slots/{id}/publish:
    post:
      tags: [Availability]
      summary: Publish slot (sinh occurrences)
      description: |
        - One-off: sinh 1 occurrence nếu không conflict.
        - Recurring (RRULE): sinh nhiều occurrences trong horizon (`publishHorizonDays`).
        - Xử lý conflict: occurrence bị đụng thời gian (kể cả buffer) sẽ bị bỏ qua và tăng `skippedConflict`.
        - Idempotent: publish lại slot đã published => trả message đã published.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Publish thành công / đã published trước đó
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PublishSlotResponse" }
              examples:
                one_off_created:
                  value:
                    published: true
                    occurrencesCreated: 1
                    skippedConflict: 0
                    rrule: null
                    horizonDays: 30
                one_off_conflict_soft_skip:
                  summary: Soft-skip khi trùng thời gian (không trả 409)
                  value:
                    published: true
                    occurrencesCreated: 0
                    skippedConflict: 1
                    rrule: null
                    horizonDays: 2
                recurring_created:
                  value:
                    published: true
                    occurrencesCreated: 8
                    skippedConflict: 1
                    rrule: "FREQ=WEEKLY;BYDAY=MO,TH;COUNT=8"
                    horizonDays: 45
                already_published:
                  summary: Idempotent publish trả counters 0/0
                  value:
                    published: true
                    occurrencesCreated: 0
                    skippedConflict: 0
                    rrule: null
                    horizonDays: 30
        "400":
          description: Slot thiếu start/end hoặc invalid RRULE
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                missing_start_end: { value: { message: "Slot start/end is required", code: "MISSING_FIELDS", data: null } }
                invalid_rrule:     { value: { message: "Invalid RRULE format", code: "INVALID_RRULE", data: null } }
        "401":
          description: Chưa đăng nhập
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                unauthorized: { value: { message: "Unauthorized", code: "UNAUTHORIZED", data: null } }
        "403":
          description: Không phải chủ sở hữu slot
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                not_owner: { value: { message: "Not owner of slot", code: "FORBIDDEN", data: null } }
        "404":
          description: Slot không tồn tại
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                slot_not_found: { value: { message: "Slot not found", code: "NOT_FOUND", data: null } }

  /availability/slots/publish-batch:
    post:
      tags: [Availability]
      summary: Publish nhiều slot cùng lúc (debug/test concurrency)
      description: |
        Nhận danh sách `ids` (slotId). Nếu `concurrent=true` thì chạy song song để mô phỏng publish đồng thời.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
                concurrent:
                  type: boolean
                  default: false
            examples:
              sequential:
                value:
                  ids: ["68ec0000000000000000a001", "68ec0000000000000000a002"]
                  concurrent: false
              concurrent:
                value:
                  ids: ["68ec0000000000000000a001", "68ec0000000000000000a002"]
                  concurrent: true
      responses:
        "200":
          description: Kết quả publish từng slot
          content:
            application/json:
              schema:
                type: object
                properties:
                  mode:
                    type: string
                    enum: [sequential, concurrent]
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string }
                        ok: { type: boolean }
                        result:
                          oneOf:
                            - $ref: "#/components/schemas/PublishSlotResponse"
                            - type: object
                        error:
                          type: string
                          nullable: true

  /availability/slots/{id}:
    patch:
      tags: [Availability]
      summary: Cập nhật slot (meta) hoặc pause/resume
      description: |
        - Meta: cập nhật title/description/timezone/start/end/visibility (không tái sinh occurrences ở đây).
        - action=pause: đặt slot vào trạng thái tạm dừng và đóng các occurrences tương lai (status=closed).
        - action=resume: bật lại slot và mở các occurrences tương lai (status=open).
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdateSlotRequest" }
            examples:
              metaOnly:
                value: { "title": "[type=in-person] Tư vấn trực tiếp", "visibility": "public" }
              pause:
                value: { "action": "pause" }
              resume:
                value: { "action": "resume" }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "OK" }
                  data:    { $ref: "#/components/schemas/AvailabilitySlot" }
        "400":
          description: Dữ liệu không hợp lệ (ISO time, end > start, action sai…)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Chưa đăng nhập
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Không phải chủ sở hữu
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Slot không tồn tại
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Availability]
      summary: Xoá slot (nếu không có booked occurrences tương lai)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "204":
          description: No Content (xoá thành công)
        "401":
          description: Chưa đăng nhập
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Không phải chủ sở hữu
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Slot không tồn tại
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Có booked occurrences tương lai, không thể xoá
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                booked_future:
                  $ref: "#/components/examples/delete_slot_409"

  /availability/calendar/{mentorId}:
    get:
      tags: [Availability]
      summary: Lịch public của mentor
      description: Trả về các occurrences mở (status=open, visibility=public) trong khoảng from/to.
      parameters:
        - in: path
          name: mentorId
          required: true
          schema: { type: string }
        - in: query
          name: from
          required: true
          schema: { type: string, format: date-time }
          examples:
            from_min:
              value: "2025-11-01T00:00:00Z"
        - in: query
          name: to
          required: true
          schema: { type: string, format: date-time }
          examples:
            to_min:
              value: "2025-11-10T00:00:00Z"
        - in: query
          name: includeClosed
          required: false
          schema: { type: boolean, default: true }
      responses:
        "200":
          description: Danh sách occurrences
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/CalendarPayload" }
              examples:
                calendar_rich:
                  value:
                    success: true
                    message: OK
                    data:
                      items:
                        - id: "66aa1b2c0000000000000001"
                          start: "2025-11-03T01:00:00Z"
                          end:   "2025-11-03T01:30:00Z"
                          status: "open"
                          title: "[type=in-person] Tư vấn trực tiếp"
                          description: "Fix CV"
                          slot:
                            id: "00000000000000000000A001"
                            title: "[type=in-person] Tư vấn trực tiếp"
                            description: "Fix CV"
                        - id: "66aa1b2c0000000000000002"
                          start: "2025-11-04T02:00:00Z"
                          end:   "2025-11-04T02:30:00Z"
                          status: "open"
                          title: "[type=video] Phiên Video Call"
                          description: "React performance"
                          slot:
                            id: "00000000000000000000A002"
                            title: "[type=video] Phiên Video Call"
                            description: "React performance"
                calendar_success_min:
                  $ref: "#/components/examples/calendar_success_min"
        "400":
          description: Thiếu hoặc sai định dạng from/to (ISO UTC) hoặc from >= to
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                invalid_range:
                  value: { message: "Invalid or missing from/to (ISO UTC expected)", code: "INVALID_RANGE", data: null }
                calendar_400_min:
                  $ref: "#/components/examples/calendar_400_min"
  # ===== BOOKINGS =====
  /bookings:
    post:
      tags: [Bookings]
      summary: Create booking (mentee)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBookingRequest"
      responses:
        "201":
          description: Booking created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/Booking" }
        "400":
          description: Invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Mentor not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Slot not available or already booked
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    get:
      tags: [Bookings]
      summary: List bookings for current user
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: role
          required: false
          schema: { type: string, enum: [mentee, mentor] }
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum:
              [
                PaymentPending,
                PendingMentor,
                Confirmed,
                Failed,
                Cancelled,
                Declined,
                Completed,
                NoShowMentor,
                NoShowMentee,
                NoShowBoth,
              ]
        - in: query
          name: page
          required: false
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 100, default: 10 }
      responses:
        "200":
          description: Booking list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/BookingListPayload" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /bookings/{id}:
    get:
      tags: [Bookings]
      summary: Get booking detail
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Booking detail
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/Booking" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Access denied
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Booking not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /bookings/{id}/cancel:
    post:
      tags: [Bookings]
      summary: Cancel booking
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CancelBookingRequest" }
      responses:
        "200":
          description: Booking cancelled
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/Booking" }
        "400":
          description: Invalid state or late cancellation
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Access denied
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Booking not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /bookings/{id}/resend-ics:
    post:
      tags: [Bookings]
      summary: Resend calendar invite for confirmed booking
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Calendar invite sent
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          sent: { type: boolean, example: true }
        "400":
          description: Invalid state
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Access denied
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Booking not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /bookings/{id}/mentor-confirm:
    post:
      tags: [Bookings]
      summary: Mentor confirms pending booking
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Booking confirmed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/Booking" }
        "400":
          description: Booking is not awaiting mentor confirmation
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Mentor access required
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Booking not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /bookings/{id}/mentor-decline:
    post:
      tags: [Bookings]
      summary: Mentor declines pending booking
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/MentorDeclineRequest" }
      responses:
        "200":
          description: Booking declined
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/Booking" }
        "400":
          description: Booking is not awaiting mentor confirmation
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Mentor access required
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Booking not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  # ===== REPORTS =====
  /reports:
    get:
      tags: [Reports]
      summary: Danh sách reports (stub)
      parameters:
        - in: query
          name: filter
          schema: { type: string, example: "{}" }
          description: JSON filter (future use)
        - in: query
          name: range
          schema: { type: string, example: "[0,9]" }
          description: JSON range [start,end]
        - in: query
          name: sort
          schema: { type: string, example: '["createdAt","DESC"]' }
          description: JSON sort [field, order]
      responses:
        "200":
          description: Report list (currently empty)
          headers:
            Content-Range:
              schema: { type: string }
              description: "reports start-end/total"
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Report" }

  /reports/{id}:
    get:
      tags: [Reports]
      summary: Lấy report theo id (stub)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Report detail
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Report" }
    put:
      tags: [Reports]
      summary: Cập nhật report (stub)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        "200":
          description: Report updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Report" }


  # ===== NOTIFICATIONS =====
  /notifications/devices:
    post:
      tags: [Notifications]
      summary: Register device token for push notifications
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeviceTokenRegisterRequest" }
      responses:
        "200":
          description: Token registered
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id: { type: string }
                          token: { type: string }
        "400":
          description: Invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    get:
      tags: [Notifications]
      summary: List device tokens (admin/root)
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: userId
          schema: { type: string }
        - in: query
          name: platform
          schema: { type: string, example: "android" }
        - in: query
          name: includeToken
          schema: { type: boolean, default: false }
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, default: 50, maximum: 200 }
      responses:
        "200":
          description: Device token list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/DeviceTokenListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications/devices/unregister:
    post:
      tags: [Notifications]
      summary: Unregister device token(s)
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeviceTokenUnregisterRequest" }
      responses:
        "200":
          description: Tokens removed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          removed: { type: integer, example: 1 }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications:
    get:
      tags: [Notifications]
      summary: List notifications for current user
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: read
          schema: { type: boolean }
        - in: query
          name: type
          schema: { $ref: "#/components/schemas/NotificationType" }
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, default: 20, maximum: 100 }
      responses:
        "200":
          description: Notification list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/NotificationListResponse"
              examples:
                page1:
                  value:
                    success: true
                    message: OK
                    data:
                      items:
                        - id: "66aa1b2c0000000000001001"
                          type: "booking_confirmed"
                          title: "Booking Confirmed"
                          body: "Your session with Nguyen A is confirmed for 2025-11-03T07:30:00Z"
                          data:
                            bookingId: "66aa1b2c0000000000000001"
                            mentorId: "66aa1b2c0000000000000002"
                            startTime: "2025-11-03T07:30:00Z"
                          read: false
                          createdAt: "2025-10-01T09:15:00Z"
                        - id: "66aa1b2c0000000000001002"
                          type: "payment_success"
                          title: "Payment Successful"
                          body: "Payment successful for your session with Nguyen A on 2025-11-03T07:30:00Z."
                          data:
                            bookingId: "66aa1b2c0000000000000001"
                            amount: 250000
                            currency: "VND"
                          read: true
                          createdAt: "2025-10-01T09:16:00Z"
                      total: 2
                      page: 1
                      limit: 20
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications/unread-count:
    get:
      tags: [Notifications]
      summary: Get unread notification count
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Unread notification count
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/NotificationUnreadCountResponse"
              examples:
                example:
                  value:
                    success: true
                    message: OK
                    data:
                      unread: 3
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications/preferences:
    get:
      tags: [Notifications]
      summary: Get notification preferences
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Notification preferences
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/NotificationPreferences"
              examples:
                example:
                  value:
                    success: true
                    message: OK
                    data:
                      pushBooking: true
                      pushPayment: true
                      pushMessage: true
                      pushSystem: true
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
    patch:
      tags: [Notifications]
      summary: Update notification preferences
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NotificationPreferences" }
      responses:
        "200":
          description: Notification preferences updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/NotificationPreferences"
              examples:
                example:
                  value:
                    success: true
                    message: Updated
                    data:
                      pushBooking: true
                      pushPayment: false
                      pushMessage: true
                      pushSystem: true
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications/read-all:
    post:
      tags: [Notifications]
      summary: Mark all notifications as read
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Notifications marked as read
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/NotificationReadAllResponse"
              examples:
                example:
                  value:
                    success: true
                    message: Notifications marked as read
                    data:
                      updated: 5
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications/{id}/read:
    patch:
      tags: [Notifications]
      summary: Mark notification as read
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Notification marked as read
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/NotificationReadResponse"
              examples:
                example:
                  value:
                    success: true
                    message: Notification marked as read
                    data:
                      id: "66aa1b2c0000000000001001"
                      read: true
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications/push/test:
    post:
      tags: [Notifications]
      summary: Send a test push to the current user
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PushTestRequest" }
      responses:
        "200":
          description: Push sent
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/PushResult" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /notifications/push:
    post:
      tags: [Notifications]
      summary: Send a push notification to a user (admin/root)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PushToUserRequest" }
      responses:
        "200":
          description: Push sent
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/PushResult" }
        "400":
          description: Invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }



  # ===== MENTORS (PUBLIC) =====
  /mentors:
    get:
      tags: [Mentors]
      summary: Danh sách mentor (public)
      parameters:
        - in: query
          name: q
          required: false
          schema: { type: string }
          description: Match name (fullName), role (jobTitle), company, skills
        - in: query
          name: skills
          required: false
          schema: { type: string }
          description: CSV các kỹ năng; match any
          example: "Kotlin,Android"
        - in: query
          name: minRating
          required: false
          schema: { type: number, minimum: 0, maximum: 5 }
          example: 4.5
        - in: query
          name: priceMin
          required: false
          schema: { type: number, minimum: 0 }
        - in: query
          name: priceMax
          required: false
          schema: { type: number, minimum: 0 }
        - in: query
          name: sort
          required: false
          schema:
            type: string
            enum: [rating_desc, price_asc, price_desc, newest]
            default: rating_desc
        - in: query
          name: page
          required: false
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 50, default: 20 }
      responses:
        "200":
          description: Danh sách mentor theo trang
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/MentorListPayload" }
              examples:
                page1:
                  value:
                    success: true
                    message: OK
                    data:
                      items:
                        - id: "68e0f6de7f19db9cfeb0df48"
                          ownerId: "68e0f6de7f19db9cfeb0df48"
                          userId: "68e0f6de7f19db9cfeb0df48"
                          name: "Nguyễn Văn A"
                          role: "Mobile Engineer"
                          company: "UIT"
                          rating: 4.7
                          ratingCount: 123
                          hourlyRate: 250000
                          skills: ["Kotlin","Compose","Android"]
                          avatarUrl: "https://i.pravatar.cc/256?img=12"
                        - id: "68e0f6de7f19db9cfeb0df49"
                          ownerId: "68e0f6de7f19db9cfeb0df49"
                          userId: "68e0f6de7f19db9cfeb0df49"
                          name: "Trần Thị B"
                          role: "Android Lead"
                          company: "UIT"
                          rating: 4.9
                          ratingCount: 87
                          hourlyRate: 400000
                          skills: ["Android","Jetpack","Coroutines"]
                          avatarUrl: "https://i.pravatar.cc/256?img=32"
                      page: 1
                      limit: 20
                      total: 123

  /mentors/{id}:
    get:
      tags: [Mentors]
      summary: Chi tiết mentor theo userId
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
          description: userId (không phải profileId)
      responses:
        "200":
          description: MentorCard
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/MentorCard" }
              examples:
                example:
                  value:
                    success: true
                    message: OK
                    data:
                      id: "68e0f6de7f19db9cfeb0df48"
                      ownerId: "68e0f6de7f19db9cfeb0df48"
                      userId: "68e0f6de7f19db9cfeb0df48"
                      name: "Nguyễn Văn A"
                      role: "Mobile Engineer"
                      company: "UIT"
                      rating: 4.7
                      ratingCount: 123
                      hourlyRate: 250000
                      skills: ["Kotlin","Compose","Android"]
                      avatarUrl: "https://i.pravatar.cc/256?img=12"
        "404":
          description: Not Found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                not_found:
                  value: { message: "Mentor not found", code: "NOT_FOUND", data: null }

  /wallet/me:
    get:
      summary: Lấy thông tin ví của người dùng hiện tại (auto-create nếu chưa có)
      tags: [Wallet]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "OK" }
                  data:
                    type: object
                    properties:
                      walletId: { type: string, nullable: true, example: "68e0f6de7f19db9cfeb0df48" }
                      balance: { type: integer, example: 1000000, description: "Balance in VND" }
                      currency: { type: string, example: "VND", enum: ["VND", "USD"] }
        "401":
          description: Unauthorized
        "403":
          description: Forbidden - Not a mentee

  /wallet/topups/mock:
    post:
      summary: Mock topup - Nạp tiền vào ví (CREDIT + MANUAL_TOPUP)
      tags: [Wallet]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount, clientRequestId]
              properties:
                amount:
                  type: number
                  example: 500000
                  description: "Số tiền nạp (VND)"
                currency:
                  type: string
                  example: "VND"
                  enum: ["VND", "USD"]
                  description: "Loại tiền tệ (optional, default VND)"
                clientRequestId:
                  type: string
                  example: "topup-uuid-12345"
                  description: "ID để đảm bảo idempotency (unique per request)"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "Created" }
                  data:
                    type: object
                    properties:
                      idempotent: { type: boolean, example: false }
                      wallet:
                        type: object
                        properties:
                          walletId: { type: string }
                          balance: { type: integer, example: 1500000 }
                          currency: { type: string, example: "VND" }
                      transaction:
                        type: object
                        properties:
                          id: { type: string }
                          type: { type: string, example: "CREDIT" }
                          source: { type: string, example: "MANUAL_TOPUP" }
                          amount: { type: integer, example: 500000 }
                          currency: { type: string, example: "VND" }
                          balanceBefore: { type: integer, example: 1000000 }
                          balanceAfter: { type: integer, example: 1500000 }
                          referenceType: { type: string, nullable: true }
                          referenceId: { type: string, nullable: true }
                          createdAt: { type: string, format: date-time }
        "200":
          description: OK (idempotent - transaction already exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "OK" }
                  data:
                    type: object
                    properties:
                      idempotent: { type: boolean, example: true }
        "400":
          description: Bad Request
        "403":
          description: Forbidden

  /wallet/debits/mock:
    post:
      summary: Mock debit - Trừ tiền từ ví (DEBIT + MANUAL_WITHDRAW)
      tags: [Wallet]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount, clientRequestId]
              properties:
                amount:
                  type: number
                  example: 200000
                  description: "Số tiền trừ (VND)"
                currency:
                  type: string
                  example: "VND"
                  enum: ["VND", "USD"]
                  description: "Loại tiền tệ (optional, default VND)"
                clientRequestId:
                  type: string
                  example: "debit-uuid-12345"
                  description: "ID để đảm bảo idempotency (unique per request)"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "Created" }
                  data:
                    type: object
                    properties:
                      idempotent: { type: boolean, example: false }
                      wallet:
                        type: object
                        properties:
                          walletId: { type: string }
                          balance: { type: integer, example: 1300000 }
                          currency: { type: string, example: "VND" }
                      transaction:
                        type: object
                        properties:
                          id: { type: string }
                          type: { type: string, example: "DEBIT" }
                          source: { type: string, example: "MANUAL_WITHDRAW" }
                          amount: { type: integer, example: 200000 }
                          currency: { type: string, example: "VND" }
                          balanceBefore: { type: integer, example: 1500000 }
                          balanceAfter: { type: integer, example: 1300000 }
                          referenceType: { type: string, nullable: true }
                          referenceId: { type: string, nullable: true }
                          createdAt: { type: string, format: date-time }
        "200":
          description: OK (idempotent - transaction already exists)
        "400":
          description: Bad Request (INSUFFICIENT_BALANCE or validation error)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: false }
                  message: { type: string, example: "INSUFFICIENT_BALANCE" }
        "403":
          description: Forbidden

  /wallet/transactions:
    get:
      summary: Lấy lịch sử giao dịch của ví (cursor-based pagination)
      tags: [Wallet]
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 50
          description: Số giao dịch mỗi page (default 20, max 50)
        - in: query
          name: cursor
          schema:
            type: string
          description: ISO timestamp để pagination (lấy từ nextCursor của response trước)
        - in: query
          name: type
          schema:
            type: string
            enum: ["CREDIT", "DEBIT", "REFUND"]
          description: Filter theo type (optional)
        - in: query
          name: source
          schema:
            type: string
            enum: ["MANUAL_TOPUP", "MANUAL_WITHDRAW", "BOOKING_PAYMENT", "BOOKING_REFUND"]
          description: Filter theo source (optional)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "OK" }
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            id: { type: string }
                            type: { type: string, enum: ["CREDIT", "DEBIT", "REFUND"] }
                            source: { type: string, enum: ["MANUAL_TOPUP", "MANUAL_WITHDRAW", "BOOKING_PAYMENT", "BOOKING_REFUND"] }
                            amount: { type: integer, example: 500000 }
                            currency: { type: string, example: "VND" }
                            balanceBefore: { type: integer, example: 1000000 }
                            balanceAfter: { type: integer, example: 1500000 }
                            referenceType: { type: string, nullable: true }
                            referenceId: { type: string, nullable: true }
                            createdAt: { type: string, format: date-time }
                      nextCursor:
                        type: string
                        nullable: true
                        example: "2025-12-08T10:30:00.000Z"
                        description: "ISO timestamp để lấy trang tiếp theo (null nếu hết)"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden - Not a mentee

  # ===== PAYMENTS =====
  /payments/webhook:
    post:
      tags: [Payments]
      summary: Payment gateway webhook (mock)
      description: Không yêu cầu auth; validate bằng signature ở production
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PaymentWebhookRequest" }
      responses:
        "200":
          description: Webhook processed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/PaymentWebhookResponseData"
        "400":
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Booking not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /payouts/requests:
    post:
      summary: Mentor tạo yêu cầu payout (rút tiền từ wallet)
      tags: [MentorPayout]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount, clientRequestId]
              properties:
                amount:
                  type: number
                  example: 1000000
                  description: "Số tiền muốn rút (VND)"
                currency:
                  type: string
                  example: "VND"
                  enum: ["VND", "USD"]
                  description: "Loại tiền tệ (optional, default VND)"
                clientRequestId:
                  type: string
                  example: "payout-req-uuid-12345"
                  description: "ID để đảm bảo idempotency"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "Created" }
                  data:
                    type: object
                    properties:
                      idempotent: { type: boolean, example: false }
                      payout:
                        type: object
                        properties:
                          id: { type: string }
                          amount: { type: integer, example: 1000000 }
                          currency: { type: string, example: "VND" }
                          status: { type: string, example: "PENDING" }
                          attemptCount: { type: integer, example: 0 }
                          externalId: { type: string, nullable: true }
                          createdAt: { type: string, format: date-time }
                          updatedAt: { type: string, format: date-time }
        "200":
          description: OK (idempotent)
        "400":
          description: Bad Request (INSUFFICIENT_BALANCE or validation error)
        "403":
          description: Forbidden - Not a mentor

  /payouts/requests/me:
    get:
      summary: Mentor xem danh sách payout requests của mình
      tags: [MentorPayout]
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 50
        - in: query
          name: cursor
          schema:
            type: string
          description: ISO timestamp for pagination
        - in: query
          name: status
          schema:
            type: string
            enum: ["PENDING", "APPROVED", "PROCESSING", "PAID", "FAILED", "CANCELLED"]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "OK" }
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            id: { type: string }
                            amount: { type: integer }
                            currency: { type: string }
                            status: { type: string }
                            attemptCount: { type: integer }
                            externalId: { type: string, nullable: true }
                            createdAt: { type: string, format: date-time }
                            updatedAt: { type: string, format: date-time }
                      nextCursor: { type: string, nullable: true }
        "403":
          description: Forbidden - Not a mentor

  /admin/payouts:
    get:
      summary: Admin xem tất cả payout requests
      tags: [MentorPayout]
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: cursor
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: mentorId
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "OK" }
                  data:
                    type: object
                    properties:
                      items: { type: array }
                      nextCursor: { type: string, nullable: true }
        "403":
          description: Forbidden - Not admin

  /admin/payouts/{id}/approve:
    post:
      summary: Admin duyệt payout request (DEBIT wallet và chuyển sang PROCESSING)
      tags: [MentorPayout]
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Payout request ID
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "OK" }
                  data:
                    type: object
                    properties:
                      payout:
                        type: object
                        properties:
                          id: { type: string }
                          amount: { type: integer }
                          currency: { type: string }
                          status: { type: string, example: "PROCESSING" }
                          attemptCount: { type: integer }
                          externalId: { type: string }
                          createdAt: { type: string }
                          updatedAt: { type: string }
        "400":
          description: Bad Request (invalid status, insufficient balance, etc.)
        "403":
          description: Forbidden - Not admin
        "404":
          description: Payout not found

  /admin/payouts/{id}/retry:
    post:
      summary: Admin retry payout đã FAILED hoặc PROCESSING
      tags: [MentorPayout]
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
        "400":
          description: Bad Request
        "403":
          description: Forbidden - Not admin
        "404":
          description: Payout not found

  /webhooks/payout-provider:
    post:
      summary: Mock webhook từ payout provider (mark PAID hoặc FAILED)
      tags: [Webhooks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [externalId, status]
              properties:
                externalId:
                  type: string
                  example: "PO-676c8e9f0000000000000001"
                  description: "External ID của payout request"
                status:
                  type: string
                  enum: ["PAID", "FAILED"]
                  description: "Status từ provider"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string }
                  data:
                    type: object
                    properties:
                      payout:
                        type: object
                        properties:
                          id: { type: string }
                          status: { type: string }
        "400":
          description: Bad Request
        "404":
          description: Payout not found

  /home/stats:
    get:
      summary: Get home screen statistics
      description: Public endpoint - Lấy thống kê tổng quan cho màn hình Home (số mentor, số session, rating trung bình, số người online)
      tags: [Home]
      responses:
        "200":
          description: Successfully retrieved statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      mentorCount:
                        type: number
                        example: 150
                        description: Tổng số mentor đang hoạt động
                      sessionCount:
                        type: number
                        example: 1234
                        description: Tổng số session đã hoàn thành hoặc đang diễn ra
                      avgRating:
                        type: number
                        format: float
                        example: 4.7
                        description: Đánh giá trung bình từ tất cả mentor
                      onlineCount:
                        type: number
                        example: 23
                        description: Số người đang online (từ Redis presence)
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: false }
                  message: { type: string, example: "Failed to get home statistics" }
                  error: { type: string }

  /presence/ping:
    post:
      summary: Update user online presence
      description: Auth required - Gửi ping để cập nhật trạng thái online trong Redis (TTL 120s)
      tags: [Presence]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Presence updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        example: "694ab5fb480851a5e45cef13"
                      expiresIn:
                        type: number
                        example: 120
                        description: Thời gian hết hạn của presence key (giây)
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: false }
                  message: { type: string, example: "Unauthorized" }
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: false }
                  message: { type: string, example: "Failed to update presence" }
                  error: { type: string }

  /bookings/{id}/review:
    post:
      tags:
        - Reviews
      summary: Tạo review cho booking đã hoàn thành
      description: |
        Mentee tạo review và rating cho mentor sau khi booking Completed.
        Business rules:
        - Chỉ mentee của booking mới được review
        - Booking phải có status = 'Completed'
        - 1 booking chỉ được review 1 lần
        - Rating từ 1-5, comment tùy chọn (max 1000 chars)
        - Tự động cập nhật profile.rating của mentor (average + count)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Booking ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - rating
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  example: 5
                  description: Rating từ 1 (tệ) đến 5 (xuất sắc)
                comment:
                  type: string
                  maxLength: 1000
                  example: "Mentor rất nhiệt tình và giúp đỡ tận tâm!"
      responses:
        "201":
          description: Review created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Review created successfully"
                  data:
                    type: object
                    properties:
                      _id:
                        type: string
                        example: "694ab5fb480851a5e45cef14"
                      booking:
                        type: string
                        example: "694ab5fb480851a5e45cef10"
                      mentee:
                        type: object
                        properties:
                          _id: { type: string }
                          userName: { type: string }
                          name: { type: string }
                          email: { type: string }
                      mentor:
                        type: object
                        properties:
                          _id: { type: string }
                          userName: { type: string }
                          name: { type: string }
                          email: { type: string }
                      rating:
                        type: integer
                        example: 5
                      comment:
                        type: string
                        example: "Mentor rất nhiệt tình!"
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
        "400":
          description: Bad request (BOOKING_NOT_COMPLETED, INVALID_RATING)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: false }
                  message: { type: string, example: "BOOKING_NOT_COMPLETED" }
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (ONLY_MENTEE_CAN_REVIEW)
        "404":
          description: Not found (BOOKING_NOT_FOUND, MENTOR_PROFILE_NOT_FOUND)
        "409":
          description: Conflict (REVIEW_ALREADY_EXISTS)

  /mentors/{id}/reviews:
    get:
      tags:
        - Reviews
      summary: Lấy danh sách review của mentor (public)
      description: |
        Endpoint public để xem tất cả reviews của mentor.
        Hỗ trợ cursor-based pagination (newest first).
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Mentor ID
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Số lượng reviews tối đa mỗi trang
        - in: query
          name: cursor
          schema:
            type: string
          description: Review ID để pagination (lấy reviews cũ hơn cursor này)
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      reviews:
                        type: array
                        items:
                          type: object
                          properties:
                            _id: { type: string }
                            booking: { type: string }
                            mentee:
                              type: object
                              properties:
                                _id: { type: string }
                                userName: { type: string }
                                name: { type: string }
                            mentor: { type: string }
                            rating: { type: integer, minimum: 1, maximum: 5 }
                            comment: { type: string }
                            createdAt: { type: string, format: date-time }
                            updatedAt: { type: string, format: date-time }
                      pagination:
                        type: object
                        properties:
                          hasMore:
                            type: boolean
                            example: true
                          nextCursor:
                            type: string
                            example: "694ab5fb480851a5e45cef15"
                            nullable: true
                          limit:
                            type: integer
                            example: 20
        "400":
          description: Bad request (INVALID_MENTOR_ID, USER_IS_NOT_MENTOR)
        "404":
          description: Not found (MENTOR_NOT_FOUND)

  /reviews/me:
    get:
      tags:
        - Reviews
      summary: Lấy danh sách reviews của mình (mentee)
      description: |
        Endpoint cho mentee xem tất cả reviews đã viết.
        Hỗ trợ cursor-based pagination (newest first).
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Số lượng reviews tối đa mỗi trang
        - in: query
          name: cursor
          schema:
            type: string
          description: Review ID để pagination
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      reviews:
                        type: array
                        items:
                          type: object
                          properties:
                            _id: { type: string }
                            booking:
                              type: object
                              properties:
                                _id: { type: string }
                                startTime: { type: string, format: date-time }
                                endTime: { type: string, format: date-time }
                                topic: { type: string }
                            mentee: { type: string }
                            mentor:
                              type: object
                              properties:
                                _id: { type: string }
                                userName: { type: string }
                                name: { type: string }
                            rating: { type: integer }
                            comment: { type: string }
                            createdAt: { type: string, format: date-time }
                            updatedAt: { type: string, format: date-time }
                      pagination:
                        type: object
                        properties:
                          hasMore: { type: boolean }
                          nextCursor: { type: string, nullable: true }
                          limit: { type: integer }
        "401":
          description: Unauthorized

  /sessions/{bookingId}/join-token:
    post:
      tags:
        - Sessions
      summary: Create a short-lived join token for WebRTC session
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: bookingId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Join token issued
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          token: { type: string }
                          expiresAt: { type: string, format: date-time }
                          role:
                            type: string
                            enum: [mentor, mentee]
        "400":
          description: Bad request (session window closed, not ready)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Booking not found

  /sessions/{bookingId}/log:
    get:
      tags:
        - Sessions
      summary: Get session log for a booking
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: bookingId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session log
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        nullable: true
                        type: object
                        properties:
                          id: { type: string }
                          bookingId: { type: string }
                          mentorId: { type: string }
                          menteeId: { type: string }
                          scheduledStart: { type: string, format: date-time }
                          scheduledEnd: { type: string, format: date-time }
                          actualStart: { type: string, format: date-time, nullable: true }
                          actualEnd: { type: string, format: date-time, nullable: true }
                          durationSec: { type: integer, nullable: true }
                          status:
                            type: string
                            enum: [waiting, active, ended, no_show]
                          endReason:
                            type: string
                            nullable: true
                            enum:
                              - completed
                              - ended_by_mentor
                              - ended_by_mentee
                              - no_show_mentor
                              - no_show_mentee
                              - no_show_both
                              - auto_end
                          waitingRoomMs: { type: integer, nullable: true }
                          mentorJoinAt: { type: string, format: date-time, nullable: true }
                          menteeJoinAt: { type: string, format: date-time, nullable: true }
                          mentorAdmitAt: { type: string, format: date-time, nullable: true }
                          mentorDisconnects: { type: integer }
                          menteeDisconnects: { type: integer }
                          qos:
                            type: object
                            nullable: true
                            properties:
                              mentor: { type: object }
                              mentee: { type: object }
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Booking not found

  /messages/{bookingId}:
    get:
      tags:
        - Messages
      summary: List chat messages for a booking
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: bookingId
          required: true
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - in: query
          name: before
          schema:
            type: string
            format: date-time
          description: Return messages before this timestamp
      responses:
        "200":
          description: Messages list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            id: { type: string }
                            bookingId: { type: string }
                            senderId: { type: string }
                            receiverId: { type: string }
                            content: { type: string }
                            messageType: { type: string, enum: [text, image, file] }
                            timestamp: { type: string, format: date-time }
                            sender:
                              type: object
                              nullable: true
                              properties:
                                id: { type: string }
                                email: { type: string, nullable: true }
                                fullName: { type: string, nullable: true }
                                avatar: { type: string, nullable: true }
                                role: { type: string, nullable: true }
                                createdAt: { type: string, format: date-time, nullable: true }
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Booking not found

  /messages/peer/{peerId}:
    get:
      tags:
        - Messages
      summary: List all chat messages with a specific peer across all bookings
      description: Retrieve conversation history with a peer (mentor or mentee) from all non-cancelled bookings
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: peerId
          required: true
          schema:
            type: string
          description: The ID of the peer user (mentor or mentee)
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 200
        - in: query
          name: before
          schema:
            type: string
            format: date-time
          description: Return messages before this timestamp
      responses:
        "200":
          description: Messages list from all bookings with the peer
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            id: { type: string }
                            bookingId: { type: string }
                            senderId: { type: string }
                            receiverId: { type: string }
                            content: { type: string }
                            messageType: { type: string, enum: [text, image, file] }
                            timestamp: { type: string, format: date-time }
                            sender:
                              type: object
                              nullable: true
                              properties:
                                id: { type: string }
                                email: { type: string, nullable: true }
                                fullName: { type: string, nullable: true }
                                avatar: { type: string, nullable: true }
                                role: { type: string, nullable: true }
                                createdAt: { type: string, format: date-time, nullable: true }
        "401":
          description: Unauthorized

  /messages/{bookingId}/restriction-info:
    get:
      tags:
        - Messages
      summary: Get chat restriction information for a booking
      description: Returns current session phase, message counts, and limits for chat restrictions
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: bookingId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Chat restriction info
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          bookingId: { type: string }
                          bookingStatus: { type: string }
                          isConfirmed: { type: boolean }
                          sessionPhase: 
                            type: string
                            enum: [pre, during, post, outside]
                            description: Current phase relative to session (pre=3 days before, during=active, post=3 days after, outside=none)
                          myMessageCount: 
                            type: integer
                            description: Total messages sent by current user for this booking
                          preSessionCount: 
                            type: integer
                            description: Messages sent in pre-session window
                          postSessionCount: 
                            type: integer
                            description: Messages sent in post-session window
                          weeklyMessageCount: 
                            type: integer
                            description: Messages sent in the last 7 days
                          limits:
                            type: object
                            properties:
                              maxFreeMessages: 
                                type: integer
                                example: 10
                                description: Max messages before booking confirmation
                              preSessionLimit: 
                                type: integer
                                example: 5
                                description: Max messages in 3-day pre-session window
                              postSessionLimit: 
                                type: integer
                                example: 3
                                description: Max messages in 3-day post-session window
                              weeklyLimit: 
                                type: integer
                                example: 2
                                description: Max messages per week outside session windows
                              sessionWindowDays: 
                                type: integer
                                example: 3
                                description: Number of days before/after session for windows
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Booking not found

  /messages:
    post:
      tags:
        - Messages
      summary: Send a chat message for a booking
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bookingId, content]
              properties:
                bookingId: { type: string }
                content: { type: string }
                messageType:
                  type: string
                  enum: [text, image, file]
      responses:
        "200":
          description: Message sent
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id: { type: string }
                          bookingId: { type: string }
                          senderId: { type: string }
                          receiverId: { type: string }
                          content: { type: string }
                          messageType: { type: string, enum: [text, image, file] }
                          timestamp: { type: string, format: date-time }
                          sender:
                            type: object
                            nullable: true
                            properties:
                              id: { type: string }
                              email: { type: string, nullable: true }
                              fullName: { type: string, nullable: true }
                              avatar: { type: string, nullable: true }
                              role: { type: string, nullable: true }
                              createdAt: { type: string, format: date-time, nullable: true }
        "400":
          description: Bad request
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Booking not found

security:
  - BearerAuth: []
